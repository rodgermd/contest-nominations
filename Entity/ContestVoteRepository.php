<?php

namespace Rodgermd\ContestNominationsBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * ContestVoteRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ContestVoteRepository extends EntityRepository
{
  /**
   * Gets last vote in contest
   * @param Contest $contest
   * @param $ipaddress
   * @return ContestVote|null
   */
  public function getLastContestVote(Contest $contest, $ipaddress)
  {
    return $this->createQueryBuilder('cv')
      ->innerJoin('cv.contest_member', 'cm')
      ->where('cm.contest = :contest')->setParameter('contest', $contest->getId())
      ->andWhere('cv.ip = :ip')->setParameter('ip', $ipaddress)
      ->orderBy('cv.created_at', 'desc')
      ->setMaxResults(1)
      ->getQuery()
      ->getOneOrNullResult();
  }
}
